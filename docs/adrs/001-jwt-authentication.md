# ADR-001: استخدام JWT للمصادقة بدلاً من Session-based Authentication

**التاريخ:** 2025-09-26  
**الحالة:** مقبول  
**المقرر:** فريق تطوير نائبك  

## السياق والمشكلة

تطبيق نائبك عبارة عن منصة سياسية موزعة تتكون من عدة خدمات مصغرة (microservices). نحتاج لاختيار استراتيجية مصادقة موحدة تدعم:

- **التوزيع:** العمل عبر خدمات متعددة
- **القابلية للتوسع:** دعم عدد كبير من المستخدمين المتزامنين
- **الأمان:** حماية بيانات المستخدمين الحساسة
- **سهولة التطوير:** تبسيط عملية التكامل بين الخدمات

## البدائل المدروسة

### 1. Session-based Authentication
**المزايا:**
- بساطة التطبيق في Django
- إمكانية إلغاء الجلسات فوراً من الخادم
- دعم أصلي في Django Admin

**العيوب:**
- الحاجة لمشاركة session store بين الخدمات
- صعوبة التوسع الأفقي (horizontal scaling)
- الحاجة لـ sticky sessions في load balancing
- استهلاك ذاكرة أكبر على الخادم

### 2. JWT (JSON Web Tokens)
**المزايا:**
- عدم الحاجة لحفظ حالة على الخادم (stateless)
- سهولة التكامل بين الخدمات المختلفة
- دعم أصلي في المتصفحات والتطبيقات المحمولة
- قابلية التوسع الأفقي بسهولة
- إمكانية تضمين معلومات إضافية في الـ token

**العيوب:**
- صعوبة إلغاء الـ tokens قبل انتهاء صلاحيتها
- حجم أكبر من session cookies
- الحاجة لإدارة refresh tokens

## القرار المتخذ

**تم اختيار JWT Authentication** للأسباب التالية:

### 1. **متطلبات المعمارية الموزعة**
- نائبك يتكون من 15 خدمة مصغرة مختلفة
- JWT يسمح بالمصادقة عبر جميع الخدمات دون الحاجة لمشاركة session store
- كل خدمة يمكنها التحقق من صحة الـ token بشكل مستقل

### 2. **القابلية للتوسع**
- JWT stateless، مما يسمح بتوسع أفقي سهل
- لا حاجة لـ sticky sessions في load balancing
- يمكن نشر الخدمات على Google Cloud Run بسهولة

### 3. **الأمان المناسب للسياق**
- استخدام refresh tokens لتقليل مخاطر تسريب access tokens
- مدة صلاحية قصيرة للـ access tokens (30 دقيقة)
- إمكانية blacklisting للـ refresh tokens عند الحاجة

### 4. **سهولة التطوير والتكامل**
- دعم ممتاز في Django REST Framework
- سهولة التكامل مع Next.js frontend
- دعم أصلي في التطبيقات المحمولة المستقبلية

## التطبيق التقني

### إعدادات JWT المستخدمة:
```python
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=30),  # مدة قصيرة للأمان
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),     # مدة معقولة للراحة
    'ROTATE_REFRESH_TOKENS': True,                   # تدوير الـ tokens للأمان
    'BLACKLIST_AFTER_ROTATION': True,                # منع إعادة استخدام الـ tokens القديمة
    'UPDATE_LAST_LOGIN': True,                       # تتبع آخر نشاط
    'ALGORITHM': 'HS256',                            # خوارزمية آمنة وسريعة
}
```

### استراتيجية الأمان:
1. **Access Tokens قصيرة المدى:** 30 دقيقة لتقليل مخاطر التسريب
2. **Refresh Token Rotation:** تغيير الـ refresh token مع كل تجديد
3. **Token Blacklisting:** إمكانية إلغاء الـ tokens عند الحاجة
4. **HTTPS Only:** جميع الـ tokens تُرسل عبر HTTPS فقط

## العواقب

### الإيجابية:
- **أداء أفضل:** لا حاجة لاستعلامات قاعدة البيانات للتحقق من الجلسات
- **توسع سهل:** يمكن إضافة خوادم جديدة دون تعقيدات
- **تكامل بسيط:** سهولة ربط الخدمات المختلفة
- **مرونة النشر:** يمكن نشر الخدمات بشكل مستقل

### السلبية:
- **إدارة معقدة للـ Tokens:** الحاجة لنظام blacklisting
- **حجم أكبر:** الـ JWT أكبر من session cookies
- **صعوبة الإلغاء الفوري:** لا يمكن إلغاء access token قبل انتهاء صلاحيته

### التخفيف من المخاطر:
1. **مدة صلاحية قصيرة:** تقليل نافذة المخاطر
2. **Refresh token rotation:** منع إعادة استخدام الـ tokens
3. **مراقبة الأمان:** تسجيل جميع عمليات المصادقة
4. **تشفير قوي:** استخدام مفاتيح تشفير قوية ومتغيرة

## المراجعة والتحديث

هذا القرار سيتم مراجعته في الحالات التالية:
- ظهور مشاكل أمنية كبيرة
- تغيير متطلبات الأداء بشكل جذري
- توفر تقنيات مصادقة جديدة أكثر ملاءمة

**آخر مراجعة:** 2025-09-26  
**المراجعة القادمة:** 2026-03-26
